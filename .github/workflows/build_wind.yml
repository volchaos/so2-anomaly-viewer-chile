name: Build daily wind overlays

on:
  schedule:
    # 20:10 UTC ≈ 17:10 Chile (UTC-3)
    - cron: "10 20 * * *"
  workflow_dispatch:
    inputs:
      run_date:
        description: "YYYY-MM-DD (UTC). Vacío = hoy UTC"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  wind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment.yml
          cache-environment: true
          init-shell: bash

      - name: Generate wind JSON (10m, 900, 400, 150)
        shell: bash -l {0}
        run: |
          set -euo pipefail
          RUN_DATE="${{ github.event.inputs.run_date }}"
          if [ -z "$RUN_DATE" ]; then
            RUN_DATE="$(python -c "import datetime as d; print(d.datetime.utcnow().date().isoformat())")"
          fi
          echo "RUN_DATE=$RUN_DATE"
echo "Lookback days (wind_config.json): $(python -c \"import json; print(json.load(open(\'wind_config.json\')).get(\'lookback_days\',\'?\'))\")"
micromamba run -n so2-wind python scripts/run_wind_daily.py "$RUN_DATE"

      - name: Commit and push if changed
        shell: bash -l {0}
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain data/wind)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/wind
            git commit -m "Add wind overlays for $(date -u +%F)"
            git push
          else
            echo "No changes in data/wind"
          fi
